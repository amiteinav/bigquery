
OPTION 1
---------
SELECT count(*) IPs_in_CIDR
FROM `armis-poc-2020.armis_agg.allipv4`
WHERE
  ipv4_as_int between 
  (SELECT NET.IPV4_TO_INT64(NET.IP_TRUNC(NET.IP_FROM_STRING(SPLIT('192.168.0.1/8', '/')[OFFSET(0)]),CAST(SPLIT('192.168.0.1/8', '/')[OFFSET(1)] AS int64))))
  and
  (SELECT NET.IPV4_TO_INT64(NET.IP_TRUNC(NET.IP_FROM_STRING(SPLIT('192.168.0.1/8', '/')[OFFSET(0)]),CAST(SPLIT('192.168.0.1/8', '/')[OFFSET(1)] AS int64)))) +
  (select CAST(POW(2,32-CAST(SPLIT('192.168.0.1/8', '/')[OFFSET(1)] AS int64)) AS INT64))

OPTION 2
--------

DECLARE MAX_IP_IN_CIDR_RANGE INT64;
DECLARE MIN_IP_IN_CIDR_RANGE INT64;
DECLARE STRING_IP STRING;
DECLARE INT_RANGE INT64;
DECLARE CIDR_RANGE STRING;
DECLARE TOTAL_ADDRESSES INT64;

SET CIDR_RANGE = '192.168.0.1/20';
SET STRING_IP = SPLIT(CIDR_RANGE, '/')[OFFSET(0)];
SET INT_RANGE = cast(SPLIT(CIDR_RANGE, '/')[OFFSET(1)] as INT64);
SET TOTAL_ADDRESSES = CAST(POW(2,32-INT_RANGE) AS INT64);
SET MIN_IP_IN_CIDR_RANGE = NET.IPV4_TO_INT64(NET.IP_TRUNC(NET.IP_FROM_STRING(STRING_IP),INT_RANGE));
SET MAX_IP_IN_CIDR_RANGE = MIN_IP_IN_CIDR_RANGE + TOTAL_ADDRESSES;

  
SELECT count(*) IPs_in_CIDR
FROM `armis-poc-2020.armis_agg.allipv4`
WHERE
  ipv4_as_int BETWEEN MIN_IP_IN_CIDR_RANGE AND MAX_IP_IN_CIDR_RANGE
 

OPTION 3
--------
DECLARE CIDR_STRING STRING DEFAULT ('192.168.0.1/20');
DECLARE STRING_IP STRING DEFAULT(REGEXP_EXTRACT(CIDR_STRING, r'(.*)/' ));
DECLARE INT_RANGE INT64 DEFAULT (cast(REGEXP_EXTRACT(CIDR_STRING, r'/(.*)') AS INT64));
DECLARE MIN_IP_IN_CIDR_RANGE INT64 DEFAULT(NET.IPV4_TO_INT64(NET.IP_TRUNC(NET.IP_FROM_STRING(STRING_IP),INT_RANGE)));
DECLARE TOTAL_ADDRESSES INT64 DEFAULT (CAST(POW(2,32-INT_RANGE) AS INT64));
DECLARE MAX_IP_IN_CIDR_RANGE INT64 DEFAULT(MIN_IP_IN_CIDR_RANGE + TOTAL_ADDRESSES);

SELECT ipv4_as_int
FROM `armis-poc-2020.armis_agg.allipv4`
WHERE
  ipv4_as_int BETWEEN MIN_IP_IN_CIDR_RANGE AND (MAX_IP_IN_CIDR_RANGE-1)
LIMIT 1


OR (if no option to use integer representation)

SELECT ipv4_as_int
FROM `armis-poc-2020.armis_agg.allipv4`
WHERE
  NET.IPV4_TO_INT64(NET.IP_FROM_STRING(ipv4_as_string)) BETWEEN MIN_IP_IN_CIDR_RANGE AND (MAX_IP_IN_CIDR_RANGE-1)
LIMIT 1



----
CREATE OR REPLACE FUNCTION armis_agg.ConvertIPStringToIPInt(IP STRING)
RETURNS INT64
Language js AS """
return IP.split('.').reduce(function(ipInt, octet) { return (ipInt<<8) + parseInt(octet, 10)}, 0) >>> 0;
""";